#!/usr/bin/env bash
echo "Init Drupal: build and launch containers"
dc build
dc down
dc up -d

{{#if_eq drupalInitProfil 'standard'}}
echo "Init Drupal: composer create-project"
rm -Rf drupal-project.tmp
composer create-project drupal-composer/drupal-project drupal-project.tmp --stability dev --no-interaction
{{/if_eq}}

{{#if_eq drupalInitProfil 'gfi'}}
echo "Init Drupal: git clone http://gitlab/PoleDigital/d8-gfi-core.git"
rm -Rf drupal-project.tmp
git clone http://gitlab/PoleDigital/d8-gfi-core.git drupal-project.tmp
rm -Rf drupal-project.tmp/.git

# TODO: Supprimer ces fichiers du repository
rm -Rf drupal-project.tmp/.docker
rm -Rf drupal-project.tmp/.bash_enter
rm -Rf drupal-project.tmp/.env
rm -Rf drupal-project.tmp/docker-compose.*
{{/if_eq}}

if [ -f "$COMPOSE_PROJECT_DIR/.gitignore" ] && [ -f "drupal-project.tmp/.gitignore" ]; then
  echo -e >> $COMPOSE_PROJECT_DIR/.gitignore
  cat drupal-project.tmp/.gitignore >> $COMPOSE_PROJECT_DIR/.gitignore
fi

cp -Rf drupal-project.tmp/. $COMPOSE_PROJECT_DIR
rm -Rf drupal-project.tmp

cd $COMPOSE_PROJECT_DIR
{{#if_eq drupalInitProfil 'gfi'}}
echo "Init Drupal: composer install"
composer install
{{/if_eq}}

cd web

echo "Init Drupal: drush site-install"
drush site-install -y {{drupalInitProfil}} --locale=fr --account-name=gfi --account-pass=gfi --account-mail=pole-digital-centre@gfi.fr --db-url={{#if_eq dbImage 'postgres'}}pgsql{{/if_eq}}{{#if_eq dbImage 'mysql'}}mysql{{/if_eq}}://{{projectName}}:{{projectName}}@db/{{projectName}} --site-name='{{projectName}}'

echo "Init Drupal: create tmp directory"
mkdir -p sites/default/files/tmp

echo "Init Drupal: create settings link"
if [ ! -f "sites/default/settings.$DOCKER_DEVBOX_ENV.php" ] && [ -f "sites/default/settings.php" ]; then
  mv sites/default/settings.php "sites/default/settings.$DOCKER_DEVBOX_ENV.php"
fi
ln -rfs "sites/default/settings.$DOCKER_DEVBOX_ENV.php" "sites/default/settings.php"
